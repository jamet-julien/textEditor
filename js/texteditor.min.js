"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),TextEditor=function(){function e(t){_classCallCheck(this,e),this._aDom=this._computeDom(t),this._bReady=!0,this._bOnAction=!1,this._oLastSelect={node:null,text:""},this._aTool=[],this._aWeakShow=new WeakMap,this._oTool=null,this._oDomTarget=null,this._oCurrentElementSelect=null,this.selection="",this.target=null}return _createClass(e,[{key:"replaceByNode",value:function(e){this._replaceSelection(e)}},{key:"replaceByText",value:function(e){this._replaceSelection(document.createTextNode(e))}},{key:"close",value:function(){this._bReady=!0,this._bOnAction=!1,this._cleanSelectZone()}},{key:"addTool",value:function(e){e&&this._aTool.push({class:e.classname||"",isShow:(e.show||function(){return!0}).bind(this),onClick:(e.click||function(){this.close()}).bind(this),content:e.content||""})}},{key:"launch",value:function(){this._oTool=this._buildTool(),this._addEvent(this._aDom)}},{key:"_getSelection",value:function(){var e,t;return window.getSelection?t=window.getSelection():document.getSelection?t=document.getSelection():(e=document.selection&&document.selection.createRange(),e.text&&(t=e.text)),t}},{key:"_replaceSelection",value:function(e){null!==this._oCurrentElementSelect&&(this.target.replaceChild(e,this._oCurrentElementSelect),this._oCurrentElementSelect=null,this._oLastSelect={node:null,text:""})}},{key:"_buildTool",value:function(){var e=this,t=document.createElement("ul"),n=null,o=null,l=this._aTool.length;for(t.className="js-editor_tool",this._aTool.reverse();l--;){if(n=document.createElement("li"),n.className="js-editor_item "+this._aTool[l].classname,""!=this._aTool[l].content)for(o=document.createElement("div"),o.innerHTML=this._aTool[l].content;o.hasChildNodes();)n.appendChild(o.firstChild);n.addEventListener("mousedown",function(t){return function(){e._bOnAction=!0,t.onClick()}}(this._aTool[l]),!1),this._aWeakShow.set(n,this._aTool[l].isShow),t.appendChild(n)}return t}},{key:"_computeDom",value:function(e){switch(!0){case e instanceof NodeList:return[].slice.call(e);case e instanceof Array:return e;case e instanceof Element:return[e];default:return null}}},{key:"_buildSelect",value:function(e){var t=document.createElement("span");document.createElement("span");return t.className="js-editor_select",t.textContent=e,t.appendChild(this._oTool),t}},{key:"_cleanSelectZone",value:function(){this._oTool.classList.remove("open"),null!==this._oLastSelect.node&&(this.selection="",this.target=null,this._oCurrentElementSelect=null,this._oLastSelect.node.deleteContents(),this._oLastSelect.node.insertNode(document.createTextNode(this._oLastSelect.text)),this._oLastSelect={node:null,text:""})}},{key:"_filterTool",value:function(){for(var e=[].slice.call(this._oTool.childNodes),t=e.length;t--;)e[t]&&(this._aWeakShow.get(e[t])()?e[t].style.display="inline-block":e[t].style.display="none")}},{key:"_computeSelectZone",value:function(e,t){this._oCurrentElementSelect=this._buildSelect(String(e)),this._oLastSelect.node=e.getRangeAt(0),this._oLastSelect.text=String(e),this._oLastSelect.node.deleteContents(),this._oLastSelect.node.insertNode(this._oCurrentElementSelect),this._filterTool()}},{key:"_showTool",value:function(e){var t=this,n=this._getSelection();this._bReady||this._bOnAction||this.close(),""!=String(n).trim()&&this._bReady&&(this.selection=String(n),this.target=e.target,this._bReady=!1,this._computeSelectZone(n,e.target),setTimeout(function(){t._oTool.classList.add("open")},50))}},{key:"_addEvent",value:function(e){for(var t=e.length;t--;)e[t]&&e[t].addEventListener("mouseup",this._showTool.bind(this))}}]),e}();